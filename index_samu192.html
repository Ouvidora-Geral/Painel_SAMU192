<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mapa ‚Ä¢ Sem Projeto e Totais por Tipo (com Normaliza√ß√£o)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0b1e39; --panel:#0e2444; --text:#e6edf7; --muted:#b7c6df; }
  html, body { height:100%; }
  body{ margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:linear-gradient(180deg,#0b1e39,#071427); color:var(--text);}
  .wrap{ max-width:1280px; margin:0 auto; padding:16px; }
  header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px; }
  h1{ margin:0; font-size:20px; }
  .panel{ background:linear-gradient(180deg,#102a52,#0b1e39); border:1px solid #1f3a69; border-radius:14px; padding:10px; color:var(--muted);}
  .ctrls{ display:flex; gap:10px; align-items:center; margin:12px 0; flex-wrap:wrap; }
  select, button, .ctrls input[type="checkbox"]{ background:#0d213e; color:var(--text); border:1px solid #23406e; border-radius:10px; padding:8px 10px; cursor:pointer }
  .ctrls label{ display:flex; align-items:center; gap:6px; }
  button:disabled{ opacity:.6; cursor:default; }
  .legend{ background:#0a1b33; color:#cfe2ff; padding:10px 12px; border-radius:12px; border:1px solid #2a4c8a; font-size:12px; line-height:1.25; box-shadow:0 8px 24px rgba(0,0,0,.35);}
  .legend .row{ display:flex; align-items:center; gap:8px; margin:4px 0; }
  .legend .swatch{ width:14px; height:14px; display:inline-block; border-radius:4px; border:1px solid rgba(255,255,255,.25);}
  .legend .title{ font-weight:700; margin-bottom:6px; }
  .footer{ margin-top:10px; font-size:12px; color:#a9bbd6; }
  table{ width:100%; border-collapse:separate; border-spacing:0; font-size:12px; }
  thead th{ text-align:left; padding:8px; background:#0e2444; position:sticky; top:0; border-bottom:1px solid #203b6b; }
  tbody td{ padding:7px 8px; border-bottom:1px dashed #173259; }
  .right{ text-align:right; }
  .hidden-col{ display:none; }

  /* Layout mapa + ranking */
  .viz { display:grid; grid-template-columns: 2fr 1fr; gap:12px; align-items:stretch; }
  #map{ height:660px; border-radius:16px; border:1px solid #1c3866; overflow:hidden; position:relative; }
  .rank-panel{ background:linear-gradient(180deg,#102a52,#0b1e39); border:1px solid #1f3a69; border-radius:14px; padding:12px; }
  .rank-title{ font-weight:700; margin-bottom:6px; color:#cfe2ff; display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .rank-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .rank-controls label{ font-size:12px; color:#cfe2ff; display:flex; align-items:center; gap:6px; }
  .rank-sub{ font-size:12px; color:#a9bbd6; margin-bottom:8px; }

  .rank-list{ display:flex; flex-direction:column; gap:6px; max-height:636px; overflow:auto; padding-right:6px; }
  .rank-item{ display:grid; grid-template-columns: 40px 1fr 72px; align-items:center; gap:8px; border-radius:10px; }
  .rank-item.alt{ background:rgba(255,255,255,.03); }
  .rank-uf{ font-weight:700; text-align:center; background:#0d213e; border:1px solid #23406e; border-radius:8px; padding:4px 6px; }
  .rank-bar-wrap{ background:#0a1b33; border:1px solid #173259; border-radius:10px; overflow:hidden; height:18px; position:relative; }
  .rank-bar{ height:100%; transition:width .25s ease; }
  .rank-bar-label{ position:absolute; left:8px; top:50%; transform:translateY(-50%); font-size:11px; color:#ffffff; text-shadow:0 1px 2px rgba(0,0,0,.6); user-select:none; pointer-events:none; }
  .rank-val{ text-align:right; font-variant-numeric: tabular-nums; color:#e6edf7; }

  /* Checkboxes de regi√£o */
  .regions{ display:flex; gap:8px; align-items:center; background:#0d213e; border:1px solid #23406e; padding:6px 10px; border-radius:10px; }
  .regions label{ display:flex; align-items:center; gap:6px; font-size:12px; color:#cfe2ff; }
  .regions input{ accent-color:#1f6feb; }

  /* Totais do recorte */
  .totals{ display:flex; gap:12px; flex-wrap:wrap; color:#cfe2ff; font-size:12px; }
  .pill{ background:#0d213e; border:1px solid #23406e; border-radius:999px; padding:6px 10px; }
  .pill b{ color:#22e1ff; }

  /* Bot√µes utilit√°rios do mapa */
  .map-actions{ position:absolute; top:10px; right:10px; display:flex; gap:8px; z-index:500; }
  .map-actions button{ background:#0d213e; border:1px solid #23406e; color:#e6edf7; border-radius:10px; padding:6px 10px; font-size:12px; }

  @media (max-width: 1024px){
    .viz{ grid-template-columns: 1fr; }
    .rank-panel{ order:2; }
    #map{ order:1; height:520px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Mapa ‚Äì Sem Projeto e Totais por Tipo</h1>
    <div class="panel">
      <div>Colora√ß√£o por m√©trica selecionada ‚Ä¢ Normaliza√ß√£o por munic√≠pio/1M hab. para tipos ‚Ä¢ Dados embutidos</div>
      <div class="totals" id="totalsBar" style="margin-top:6px;"></div>
    </div>
  </header>

  <div class="ctrls">
    <label>M√©trica:&nbsp;
      <select id="metric">
        <optgroup label="Sem Projeto (percentual global)">
          <option value="pct_mun_semproj">% de munic√≠pios sem projeto</option>
          <option value="pct_pop_semproj">% da popula√ß√£o sem projeto</option>
        </optgroup>
        <optgroup label="Totais por tipo (todas as situa√ß√µes)">
          <option value="CRU">CRU</option>
          <option value="USA">USA</option>
          <option value="USB">USB</option>
          <option value="Aero">A√©reo</option>
          <option value="Moto">Moto</option>
          <option value="Lancha">Lancha</option>
        </optgroup>
      </select>
    </label>
    <label>Normaliza√ß√£o (para tipos):&nbsp;
      <select id="norm">
        <option value="abs">Absoluto</option>
        <option value="per_mun">Por 100 munic√≠pios</option>
        <option value="per_pop">Por 1 milh√£o de habitantes</option>
      </select>
    </label>

    <!-- Filtros por regi√£o -->
    <div class="regions" id="regionsBox" title="Filtrar por Regi√£o">
      <strong style="color:#cfe2ff;">Regi√µes:</strong>
      <label><input type="checkbox" value="N"  checked> N</label>
      <label><input type="checkbox" value="NE" checked> NE</label>
      <label><input type="checkbox" value="CO" checked> CO</label>
      <label><input type="checkbox" value="SE" checked> SE</label>
      <label><input type="checkbox" value="S"  checked> S</label>
      <button id="btnToggleRegions" style="margin-left:6px;">(Des)marcar todas</button>
    </div>

    <button id="btnExport">Exportar tabela (CSV)</button>
    <label><input type="checkbox" id="toggleHideMetricCol"> Ocultar coluna ‚ÄúValor (m√©trica)‚Äù</label>
  </div>

  <div class="viz">
    <div id="map">
      <div class="map-actions">
        <button id="btnCopyPng" title="Copiar o mapa como PNG">Copiar PNG</button>
      </div>
    </div>

    <!-- Painel Ranking -->
    <div class="rank-panel">
      <div class="rank-title">
        <span>Ranking</span>
        <div class="rank-controls">
          <label for="rankSize">Mostrar:</label>
          <select id="rankSize" title="Tamanho do ranking">
            <option value="5">Top 5</option>
            <option value="10" selected>Top 10</option>
            <option value="27">Top 27 (todos)</option>
          </select>
          <button id="btnRankOrder" title="Alternar ordena√ß√£o">DESC</button>
          <label><input type="checkbox" id="rankValuesInBar"> Mostrar valores na barra</label>
          <label><input type="checkbox" id="rankAltRows"> Linhas alternadas</label>
          <button id="btnRankCSV" title="Baixar CSV do ranking">CSV Ranking</button>
        </div>
      </div>
      <div class="rank-sub" id="rankInfo">Baseado na m√©trica atual e regi√µes filtradas</div>
      <div class="rank-list" id="rankList"></div>
    </div>
  </div>

  <div class="footer">Percentuais de ‚ÄúSem Projeto‚Äù usam faixas fixas: 0‚Äì2%, 2‚Äì5%, 5‚Äì10%, 10‚Äì15%, 15‚Äì25%, &gt;25%. Para as m√©tricas de tipos, a escala √© ajustada automaticamente (quantis) conforme a normaliza√ß√£o escolhida e as regi√µes selecionadas.</div>

  <div class="panel" style="margin-top:12px;">
    <strong>Tabela resumo (apenas estados filtrados)</strong>
    <div style="max-height:420px; overflow:auto; margin-top:8px; border-radius:10px; border:1px solid #173259;">
      <table id="tbl">
        <thead><tr>
          <th>UF</th>
          <th class="right">Mun. (total)</th>
          <th class="right">Pop. (total)</th>
          <th class="right">Mun. SemProj</th>
          <th class="right">Pop. SemProj</th>
          <th class="right">% Mun. SemProj</th>
          <th class="right">% Pop. SemProj</th>
          <th class="right">CRU</th>
          <th class="right">USA</th>
          <th class="right">USB</th>
          <th class="right">A√©reo</th>
          <th class="right">Moto</th>
          <th class="right">Lancha</th>
          <th class="right" id="thMetricVal">Valor (m√©trica)</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ===================== DADOS ===================== */
const DATA = [{"UF":"AC","Municipios_Total":22,"Pop_Total":906876,"Municipios_SemProj":3,"Pop_SemProj":28154,"CRU":0,"USA":30,"USB":33,"Moto":0,"Lancha":0,"Aero":2,"pct_mun_semproj":0.8771929824561403,"pct_pop_semproj":0.3027922649028037},{"UF":"AL","Municipios_Total":102,"Pop_Total":3381570,"Municipios_SemProj":2,"Pop_SemProj":93547,"CRU":0,"USA":33,"USB":63,"Moto":0,"Lancha":0,"Aero":2,"pct_mun_semproj":0.5847953216374269,"pct_pop_semproj":1.0059752626313158},{"UF":"AM","Municipios_Total":62,"Pop_Total":4269995,"Municipios_SemProj":5,"Pop_SemProj":117917,"CRU":0,"USA":24,"USB":33,"Moto":0,"Lancha":4,"Aero":2,"pct_mun_semproj":1.4619883040935673,"pct_pop_semproj":1.268221240633971},{"UF":"AP","Municipios_Total":16,"Pop_Total":877613,"Municipios_SemProj":1,"Pop_SemProj":43235,"CRU":0,"USA":7,"USB":10,"Moto":0,"Lancha":0,"Aero":1,"pct_mun_semproj":0.29239766081871345,"pct_pop_semproj":0.4646582083187638},{"UF":"BA","Municipios_Total":417,"Pop_Total":14925825,"Municipios_SemProj":32,"Pop_SemProj":972719,"CRU":0,"USA":148,"USB":298,"Moto":0,"Lancha":1,"Aero":6,"pct_mun_semproj":9.35672514619883,"pct_pop_semproj":10.44766876453114},{"UF":"CE","Municipios_Total":184,"Pop_Total":9291631,"Municipios_SemProj":3,"Pop_SemProj":118393,"CRU":0,"USA":54,"USB":149,"Moto":0,"Lancha":0,"Aero":4,"pct_mun_semproj":0.8771929824561403,"pct_pop_semproj":1.2727619785515148},{"UF":"DF","Municipios_Total":1,"Pop_Total":3094325,"Municipios_SemProj":0,"Pop_SemProj":0,"CRU":0,"USA":22,"USB":17,"Moto":0,"Lancha":0,"Aero":1,"pct_mun_semproj":0.0,"pct_pop_semproj":0.0},{"UF":"ES","Municipios_Total":78,"Pop_Total":4064052,"Municipios_SemProj":0,"Pop_SemProj":0,"CRU":0,"USA":33,"USB":63,"Moto":0,"Lancha":0,"Aero":1,"pct_mun_semproj":0.0,"pct_pop_semproj":0.0},{"UF":"GO","Municipios_Total":246,"Pop_Total":7206589,"Municipios_SemProj":1,"Pop_SemProj":15183,"CRU":0,"USA":61,"USB":149,"Moto":0,"Lancha":0,"Aero":2,"pct_mun_semproj":0.29239766081871345,"pct_pop_semproj":0.16319990914472232},{"UF":"MA","Municipios_Total":217,"Pop_Total":7386591,"Municipios_SemProj":9,"Pop_SemProj":147208,"CRU":0,"USA":51,"USB":146,"Moto":0,"Lancha":5,"Aero":2,"pct_mun_semproj":2.6315789473684212,"pct_pop_semproj":1.582969193522965},{"UF":"MG","Municipios_Total":853,"Pop_Total":21292666,"Municipios_SemProj":16,"Pop_SemProj":369619,"CRU":0,"USA":240,"USB":616,"Moto":0,"Lancha":0,"Aero":9,"pct_mun_semproj":4.678362573099415,"pct_pop_semproj":3.9726939899160223},{"UF":"MS","Municipios_Total":79,"Pop_Total":2839188,"Municipios_SemProj":2,"Pop_SemProj":19478,"CRU":0,"USA":21,"USB":47,"Moto":0,"Lancha":0,"Aero":2,"pct_mun_semproj":0.5847953216374269,"pct_pop_semproj":0.20928614256063663},{"UF":"MT","Municipios_Total":141,"Pop_Total":3567234,"Municipios_SemProj":8,"Pop_SemProj":120747,"CRU":0,"USA":40,"USB":97,"Moto":0,"Lancha":2,"Aero":2,"pct_mun_semproj":2.3391812865497074,"pct_pop_semproj":1.2990388420223124},{"UF":"PA","Municipios_Total":144,"Pop_Total":8777124,"Municipios_SemProj":8,"Pop_SemProj":314776,"CRU":0,"USA":53,"USB":120,"Moto":0,"Lancha":8,"Aero":3,"pct_mun_semproj":2.3391812865497074,"pct_pop_semproj":3.3860619426664735},{"UF":"PB","Municipios_Total":223,"Pop_Total":4025558,"Municipios_SemProj":2,"Pop_SemProj":10021,"CRU":0,"USA":46,"USB":136,"Moto":0,"Lancha":0,"Aero":2,"pct_mun_semproj":0.5847953216374269,"pct_pop_semproj":0.1077869722568376},{"UF":"PE","Municipios_Total":185,"Pop_Total":9699259,"Municipios_SemProj":2,"Pop_SemProj":49666,"CRU":0,"USA":75,"USB":146,"Moto":0,"Lancha":0,"Aero":3,"pct_mun_semproj":0.5847953216374269,"pct_pop_semproj":0.534676234541743},{"UF":"PI","Municipios_Total":224,"Pop_Total":3289290,"Municipios_SemProj":2,"Pop_SemProj":20686,"CRU":0,"USA":33,"USB":97,"Moto":0,"Lancha":0,"Aero":2,"pct_mun_semproj":0.5847953216374269,"pct_pop_semproj":0.22265861240612945},{"UF":"PR","Municipios_Total":399,"Pop_Total":11597484,"Municipios_SemProj":10,"Pop_SemProj":240889,"CRU":0,"USA":128,"USB":281,"Moto":0,"Lancha":0,"Aero":6,"pct_mun_semproj":2.9239756981871347,"pct_pop_semproj":2.5923850905092116},{"UF":"RJ","Municipios_Total":92,"Pop_Total":17463349,"Municipios_SemProj":1,"Pop_SemProj":17588,"CRU":0,"USA":86,"USB":156,"Moto":0,"Lancha":0,"Aero":6,"pct_mun_semproj":0.29239766081871345,"pct_pop_semproj":0.1891791625926621},{"UF":"RN","Municipios_Total":167,"Pop_Total":3560903,"Municipios_SemProj":1,"Pop_SemProj":18906,"CRU":0,"USA":35,"USB":98,"Moto":0,"Lancha":0,"Aero":2,"pct_mun_semproj":0.29239766081871345,"pct_pop_semproj":0.20323965621377003},{"UF":"RO","Municipios_Total":52,"Pop_Total":1608895,"Municipios_SemProj":1,"Pop_SemProj":7710,"CRU":0,"USA":21,"USB":35,"Moto":0,"Lancha":0,"Aero":1,"pct_mun_semproj":0.29239766081871345,"pct_pop_semproj":0.08295341179768661},{"UF":"RR","Municipios_Total":15,"Pop_Total":652713,"Municipios_SemProj":2,"Pop_SemProj":40417,"CRU":0,"USA":8,"USB":10,"Moto":0,"Lancha":1,"Aero":1,"pct_mun_semproj":0.5847953216374269,"pct_pop_semproj":0.4350857098993877},{"UF":"RS","Municipios_Total":497,"Pop_Total":11466630,"Municipios_SemProj":20,"Pop_SemProj":338152,"CRU":0,"USA":116,"USB":353,"Moto":0,"Lancha":0,"Aero":6,"pct_mun_semproj":5.847953216374269,"pct_pop_semproj":3.650730999229858},{"UF":"SC","Municipios_Total":295,"Pop_Total":7338473,"Municipios_SemProj":6,"Pop_SemProj":93982,"CRU":0,"USA":76,"USB":211,"Moto":0,"Lancha":0,"Aero":5,"pct_mun_semproj":1.7543859649122806,"pct_pop_semproj":1.0140873774063233},{"UF":"SE","Municipios_Total":75,"Pop_Total":2355920,"Municipios_SemProj":2,"Pop_SemProj":15484,"CRU":0,"USA":19,"USB":51,"Moto":0,"Lancha":0,"Aero":1,"pct_mun_semproj":0.5847953216374269,"pct_pop_semproj":0.16706442280729178},{"UF":"SP","Municipios_Total":645,"Pop_Total":46649132,"Municipios_SemProj":2,"Pop_SemProj":35085,"CRU":0,"USA":263,"USB":720,"Moto":0,"Lancha":0,"Aero":11,"pct_mun_semproj":0.5847953216374269,"pct_pop_semproj":0.37927189124127263},{"UF":"TO","Municipios_Total":139,"Pop_Total":1590248,"Municipios_SemProj":3,"Pop_SemProj":31618,"CRU":0,"USA":27,"USB":67,"Moto":0,"Lancha":0,"Aero":2,"pct_mun_semproj":0.8771929824561403,"pct_pop_semproj":0.3420497804036157}];

/* Regi√µes por UF */
const UF2REG = { AC:'N', AL:'NE', AM:'N', AP:'N', BA:'NE', CE:'NE', DF:'CO', ES:'SE', GO:'CO', MA:'NE', MG:'SE', MS:'CO', MT:'CO', PA:'N', PB:'NE', PE:'NE', PI:'NE', PR:'S', RJ:'SE', RN:'NE', RO:'N', RR:'N', RS:'S', SC:'S', SE:'NE', SP:'SE', TO:'N' };

const PALETTE = ['#133c7a','#1f6feb','#22e1ff','#00e69f','#ffd166','#ff006e'];
const BINS_PERCENT = [2,5,10,15,25,100];
const GEOJSON_URL = "https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/brazil-states.geojson";
const name2uf = {
  "Acre":"AC","Alagoas":"AL","Amazonas":"AM","Amap√°":"AP","Bahia":"BA","Cear√°":"CE","Distrito Federal":"DF","Esp√≠rito Santo":"ES","Goi√°s":"GO","Maranh√£o":"MA",
  "Minas Gerais":"MG","Mato Grosso do Sul":"MS","Mato Grosso":"MT","Par√°":"PA","Para√≠ba":"PB","Pernambuco":"PE","Piau√≠":"PI","Paran√°":"PR","Rio de Janeiro":"RJ",
  "Rio Grande do Norte":"RN","Rond√¥nia":"RO","Roraima":"RR","Rio Grande do Sul":"RS","Santa Catarina":"SC","Sergipe":"SE","S√£o Paulo":"SP","Tocantins":"TO"
};

let map, layer, metricSelect, normSelect, legendControl;
let _breaks = [];
let _layersByUF = {}; // √≠ndice UF -> layer
let _rankOrder = 'desc'; // 'asc' ou 'desc'
let _rankTop = 10;      // 5, 10, 27
let _rankShowValuesInBar = false;
let _rankAltRows = false;
let _hideMetricCol = false;

/* ======= PREFER√äNCIAS (localStorage) ======= */
const STORAGE_KEY = 'mapa_ui_prefs_v1';

function savePrefs(){
  try{
    const prefs = {
      rankOrder: _rankOrder,
      rankTop: _rankTop,
      rankShowValuesInBar: _rankShowValuesInBar,
      rankAltRows: _rankAltRows,
      hideMetricCol: _hideMetricCol,
      regions: getSelectedRegions()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
  }catch(e){ /* ignore */ }
}

function loadPrefs(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}

function applyPrefsToUI(prefs){
  if(!prefs) return;
  // Regi√µes
  if (Array.isArray(prefs.regions) && prefs.regions.length){
    const cbs = document.querySelectorAll('#regionsBox input[type="checkbox"]');
    cbs.forEach(cb=> cb.checked = prefs.regions.includes(cb.value));
  }
  // Ranking
  if (prefs.rankOrder === 'asc' || prefs.rankOrder === 'desc') _rankOrder = prefs.rankOrder;
  if (typeof prefs.rankTop === 'number'){
    _rankTop = prefs.rankTop;
    const sel = document.getElementById('rankSize'); if (sel) sel.value = String(_rankTop);
  }
  if (typeof prefs.rankShowValuesInBar === 'boolean'){
    _rankShowValuesInBar = prefs.rankShowValuesInBar;
    const cb = document.getElementById('rankValuesInBar'); if (cb) cb.checked = _rankShowValuesInBar;
  }
  if (typeof prefs.rankAltRows === 'boolean'){
    _rankAltRows = prefs.rankAltRows;
    const cb = document.getElementById('rankAltRows'); if (cb) cb.checked = _rankAltRows;
  }
  if (typeof prefs.hideMetricCol === 'boolean'){
    _hideMetricCol = prefs.hideMetricCol;
    const cb = document.getElementById('toggleHideMetricCol'); if (cb) cb.checked = _hideMetricCol;
  }
}

/* ===================== HELPERS ===================== */
function toBR(n,dec=0){ if(n==null || isNaN(n)) return '‚Äî'; return Number(n).toLocaleString('pt-BR', { minimumFractionDigits: dec, maximumFractionDigits: dec }); }
function quantileBreaks(values){
  const vs = values.filter(v=> typeof v==='number' && !isNaN(v)).sort((a,b)=>a-b);
  if (vs.length===0) return [0,0,0,0,0,0];
  const q = p=> vs[Math.floor((vs.length-1)*p)];
  return [q(0.15), q(0.30), q(0.50), q(0.70), q(0.85), vs[vs.length-1]];
}
function colorForPercent(v){ if (v==null || isNaN(v)) return '#0e1a2c'; for (let i=0;i<BINS_PERCENT.length;i++){ if (v <= BINS_PERCENT[i]) return PALETTE[i]; } return PALETTE[PALETTE.length-1]; }
function colorForQuantile(v, breaks){ if (v==null || isNaN(v)) return '#0e1a2c'; for (let i=0;i<breaks.length;i++){ if (v <= breaks[i]) return PALETTE[i]; } return PALETTE[PALETTE.length-1]; }

function currentValue(rec, metric, norm){
  if(metric==='pct_mun_semproj') return rec.pct_mun_semproj;
  if(metric==='pct_pop_semproj') return rec.pct_pop_semproj;
  const base = rec[metric];
  if (norm==='abs') return base;
  if (norm==='per_mun') return rec.Municipios_Total ? base / rec.Municipios_Total * 100 : null;
  if (norm==='per_pop') return rec.Pop_Total ? base / (rec.Pop_Total/1_000_000) : null;
  return base;
}

function getSelectedRegions(){
  const box = document.getElementById('regionsBox');
  return [...box.querySelectorAll('input[type="checkbox"]')].filter(c=>c.checked).map(c=>c.value);
}
function filterByRegion(data){
  const regs = getSelectedRegions();
  return data.filter(d => regs.includes(UF2REG[d.UF]));
}

/* ===================== RENDER: TOTAIS DO RECORTE ===================== */
function renderTotals(){
  const subset = filterByRegion(DATA);
  const totals = subset.reduce((acc,r)=>({
    uf: acc.uf+1,
    mun: acc.mun + (r.Municipios_Total||0),
    pop: acc.pop + (r.Pop_Total||0),
    munSem: acc.munSem + (r.Municipios_SemProj||0),
    popSem: acc.popSem + (r.Pop_SemProj||0)
  }), {uf:0, mun:0, pop:0, munSem:0, popSem:0});
  const bar = document.getElementById('totalsBar');
  bar.innerHTML = `
    <span class="pill">UFs selecionadas: <b>${toBR(totals.uf)}</b></span>
    <span class="pill">Munic√≠pios: <b>${toBR(totals.mun)}</b></span>
    <span class="pill">Popula√ß√£o: <b>${toBR(totals.pop)}</b></span>
    <span class="pill">Mun. Sem Projeto: <b>${toBR(totals.munSem)}</b></span>
    <span class="pill">Pop. Sem Projeto: <b>${toBR(totals.popSem)}</b></span>
  `;
}

/* ===================== RENDER: TABELA ===================== */
function renderTable(){
  const tbody = document.querySelector('#tbl tbody'); tbody.innerHTML='';
  const metric = metricSelect.value;
  const norm = normSelect.value;
  let rows = filterByRegion(DATA).map(rec=> Object.assign({}, rec, { _val: currentValue(rec, metric, norm) }));
  rows.sort((a,b)=> (b._val??-Infinity) - (a._val??-Infinity));

  const th = document.getElementById('thMetricVal');
  th.classList.toggle('hidden-col', _hideMetricCol);

  rows.forEach(r=>{
    const dec = (metric.startsWith('pct_') ? 2 : (norm==='abs'?0:2));
    const tdMetric = `<td class="right ${_hideMetricCol?'hidden-col':''}"><strong>${toBR(r._val, dec)}${metric.startsWith('pct_')?'%':''}</strong></td>`;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.UF}</td>
      <td class="right">${toBR(r.Municipios_Total)}</td>
      <td class="right">${toBR(r.Pop_Total)}</td>
      <td class="right">${toBR(r.Municipios_SemProj)}</td>
      <td class="right">${toBR(r.Pop_SemProj)}</td>
      <td class="right">${toBR(r.pct_mun_semproj,2)}%</td>
      <td class="right">${toBR(r.pct_pop_semproj,2)}%</td>
      <td class="right">${toBR(r.CRU)}</td>
      <td class="right">${toBR(r.USA)}</td>
      <td class="right">${toBR(r.USB)}</td>
      <td class="right">${toBR(r.Aero)}</td>
      <td class="right">${toBR(r.Moto)}</td>
      <td class="right">${toBR(r.Lancha)}</td>
      ${tdMetric}`;
    tbody.appendChild(tr);
  });
}

/* ===================== RENDER: RANKING ===================== */
function rankingDataSorted(){
  const metric = metricSelect.value;
  const norm = normSelect.value;
  let subset = filterByRegion(DATA).map(r => ({...r, _val: currentValue(r, metric, norm)}));
  subset.sort((a,b)=>{
    const va = a._val??-Infinity, vb = b._val??-Infinity;
    return _rankOrder==='desc' ? (vb - va) : (va - vb);
  });
  return subset;
}

function renderRanking(breaks){
  const metric = metricSelect.value;
  const norm = normSelect.value;
  const list = document.getElementById('rankList'); list.innerHTML = '';
  const subset = rankingDataSorted();

  const topCount = Math.min(_rankTop, subset.length);
  const top = subset.slice(0, topCount);
  const maxVal = Math.max(...top.map(r => r._val ?? 0), 1);
  document.getElementById('rankInfo').textContent =
    `Top ${topCount} ‚Ä¢ Ordem: ${_rankOrder.toUpperCase()} ‚Ä¢ M√©trica: ${metric}${!metric.startsWith('pct_') ? ` (${norm})` : ''}`;

  top.forEach((r, idx)=>{
    const dec = (metric.startsWith('pct_') ? 2 : (norm==='abs'?0:2));
    const widthPct = Math.max(3, Math.round((r._val / maxVal) * 100));
    const color = metric.startsWith('pct_') ? colorForPercent(r._val) : colorForQuantile(r._val, breaks);
    const item = document.createElement('div');
    item.className = 'rank-item';
    if (_rankAltRows && (idx % 2 === 1)) item.classList.add('alt');

    const valueStr = `${toBR(r._val, dec)}${metric.startsWith('pct_')?'%':''}`;

    item.innerHTML = `
      <div class="rank-uf" data-uf="${r.UF}">${r.UF}</div>
      <div class="rank-bar-wrap">
        <div class="rank-bar" style="width:${widthPct}%; background:${color}"></div>
        ${_rankShowValuesInBar ? `<div class="rank-bar-label">${valueStr}</div>` : ``}
      </div>
      <div class="rank-val">${valueStr}</div>
    `;

    item.addEventListener('mouseenter', ()=> highlightUF(r.UF, true));
    item.addEventListener('mouseleave', ()=> highlightUF(r.UF, false));
    item.addEventListener('click', ()=> {
      const lyr = _layersByUF[r.UF];
      if (lyr){ map.fitBounds(lyr.getBounds(), {maxZoom:6}); showPopup(r.UF, lyr); }
    });

    list.appendChild(item);
  });

  document.getElementById('btnRankOrder').textContent = _rankOrder.toUpperCase();
}

/* ===================== LEGENDA ===================== */
function buildLegend(metric){
  if (legendControl) legendControl.remove();
  legendControl = L.control({position:'bottomright'});
  legendControl.onAdd = function(){
    const div = L.DomUtil.create('div','legend');
    const norm = normSelect.value;
    if (metric.startsWith('pct_')){
      div.innerHTML = `<div class="title">${metric==='pct_mun_semproj' ? '% de Munic√≠pios sem projeto' : '% da Popula√ß√£o sem projeto'}</div>`;
      const ranges = ['0‚Äì2%','2‚Äì5%','5‚Äì10%','10‚Äì15%','15‚Äì25%','>25%'];
      for (let i=0;i<ranges.length;i++){
        const row = document.createElement('div');
        row.className='row';
        row.innerHTML = `<span class="swatch" style="background:${PALETTE[i]}"></span> ${ranges[i]}`;
        div.appendChild(row);
      }
    } else {
      const titleMetric = metric + (norm==='abs' ? ' (abs.)' : norm==='per_mun' ? ' /100 mun.' : ' /1M hab.');
      div.innerHTML = `<div class="title">${titleMetric}</div>`;
      const br = _breaks || [];
      for (let i=0;i<br.length;i++){
        const from = (i===0? 0 : br[i-1]);
        const to = br[i];
        const row = document.createElement('div');
        row.className='row';
        row.innerHTML = `<span class="swatch" style="background:${PALETTE[i]}"></span> ${toBR(from,2)}‚Äì${toBR(to,2)}`;
        div.appendChild(row);
      }
    }
    return div;
  };
  legendControl.addTo(map);
}

/* ===================== DESENHO DO MAPA ===================== */
function draw(){
  const metric = metricSelect.value;
  const norm = normSelect.value;
  const filtered = filterByRegion(DATA);

  const vals = filtered.map(r=> currentValue(r, metric, norm));
  let breaks = null;

  if (metric.startsWith('pct_')){
    breaks = BINS_PERCENT.slice();
    Object.entries(_layersByUF).forEach(([uf, lyr])=>{
      const rec = DATA.find(d=> d.UF===uf);
      const val = rec ? currentValue(rec, metric, norm) : null;
      const inReg = filtered.some(d=> d.UF===uf);
      lyr.setStyle({
        fillColor: colorForPercent(val),
        fillOpacity: inReg ? 0.65 : 0.15,
        opacity: inReg ? 1 : 0.5,
        weight: 1
      });
    });
  } else {
    breaks = quantileBreaks(vals);
    Object.entries(_layersByUF).forEach(([uf, lyr])=>{
      const rec = DATA.find(d=> d.UF===uf);
      const val = rec ? currentValue(rec, metric, norm) : null;
      const inReg = filtered.some(d=> d.UF===uf);
      lyr.setStyle({
        fillColor: colorForQuantile(val, breaks),
        fillOpacity: inReg ? 0.65 : 0.15,
        opacity: inReg ? 1 : 0.5,
        weight: 1
      });
    });
  }

  _breaks = breaks;
  renderTotals();
  buildLegend(metric);
  renderTable();
  renderRanking(breaks);
}

/* ===================== POPUP ===================== */
function showPopup(uf, layerRef){
  const rec = DATA.find(d => d.UF === uf);
  if(!rec) return;
  const html = `
    <b>${uf}</b><br>
    <b>Geral</b><br>
    Mun.: ${toBR(rec.Municipios_Total)} ‚Ä¢ Pop.: ${toBR(rec.Pop_Total)}<br>
    <b>Sem Projeto</b> ‚Äì Mun.: ${toBR(rec.Municipios_SemProj)} ‚Ä¢ Pop.: ${toBR(rec.Pop_SemProj)}<br>
    % Mun.: ${toBR(rec.pct_mun_semproj,2)}% ‚Ä¢ % Pop.: ${toBR(rec.pct_pop_semproj,2)}%<br>
    <hr style="border:0;border-top:1px solid #23406e">
    <b>Totais por tipo</b><br>
    CRU: ${toBR(rec.CRU)} ‚Ä¢ USA: ${toBR(rec.USA)} ‚Ä¢ USB: ${toBR(rec.USB)}<br>
    A√©reo: ${toBR(rec.Aero)} ‚Ä¢ Moto: ${toBR(rec.Moto)} ‚Ä¢ Lancha: ${toBR(rec.Lancha)}
  `;
  layerRef.bindPopup(html).openPopup();
}

/* ===================== EXPORT CSV TABELA ===================== */
function exportCSV(){
  const metric = metricSelect.value;
  const norm = normSelect.value;
  const headers = ['UF','Municipios_Total','Pop_Total','Municipios_SemProj','Pop_SemProj','pct_mun_semproj','pct_pop_semproj','CRU','USA','USB','Aero','Moto','Lancha','valor_metric'];
  const rows = filterByRegion(DATA).map(r=>{
    const v = currentValue(r, metric, norm);
    return [r.UF,r.Municipios_Total,r.Pop_Total,r.Municipios_SemProj,r.Pop_SemProj,r.pct_mun_semproj,r.pct_pop_semproj,r.CRU,r.USA,r.USB,r.Aero,r.Moto,r.Lancha,v];
  });
  const csv = [headers.join(','), ...rows.map(a=> a.join(','))].join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='mapa_resumo.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ===================== EXPORT CSV RANKING ===================== */
function exportRankingCSV(){
  const metric = metricSelect.value;
  const norm = normSelect.value;
  const subset = rankingDataSorted();
  const top = subset.slice(0, Math.min(_rankTop, subset.length));
  const headers = ['pos','UF','valor','metrica','normalizacao','ordem','top'];
  const rows = top.map((r,i)=>[
    i+1, r.UF, r._val, metric, metric.startsWith('pct_')? '‚Äî' : norm, _rankOrder, _rankTop
  ]);
  const csv = [headers.join(','), ...rows.map(a=> a.join(','))].join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='ranking.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ===================== COPIAR PNG DO MAPA ===================== */
async function copyMapAsPNG(){
  const btn = document.getElementById('btnCopyPng');
  btn.disabled = true; const original = btn.textContent; btn.textContent = 'Gerando...';
  try{
    const mapEl = document.getElementById('map');
    const canvas = await html2canvas(mapEl, {useCORS:true, backgroundColor:null, scale:2});
    const blob = await new Promise(res=> canvas.toBlob(res, 'image/png'));
    if (navigator.clipboard && window.ClipboardItem){
      await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
      btn.textContent = 'Copiado ‚úî';
    } else {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='mapa.png'; a.click(); URL.revokeObjectURL(url);
      btn.textContent = 'Baixado ‚úî';
    }
  } catch(e){
    console.error(e);
    btn.textContent = 'Erro üòï';
  } finally{
    setTimeout(()=>{ btn.disabled=false; btn.textContent = original; }, 1200);
  }
}

/* ===================== INIT ===================== */
async function init(){
  metricSelect = document.getElementById('metric');
  normSelect = document.getElementById('norm');
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  metricSelect.addEventListener('change', ()=>{ draw(); /* metric/norm n√£o entram nas prefs */ });
  normSelect.addEventListener('change', ()=>{ draw(); });

  // filtros de regi√µes
  document.querySelectorAll('#regionsBox input[type="checkbox"]').forEach(cb=> cb.addEventListener('change', ()=>{ draw(); savePrefs(); }));
  document.getElementById('btnToggleRegions').addEventListener('click', ()=>{
    const checks = [...document.querySelectorAll('#regionsBox input[type="checkbox"]')];
    const allOn = checks.every(c=>c.checked);
    checks.forEach(c=> c.checked = !allOn);
    draw(); savePrefs();
  });

  // ranking: alternar ordena√ß√£o
  document.getElementById('btnRankOrder').addEventListener('click', ()=>{
    _rankOrder = (_rankOrder==='desc') ? 'asc' : 'desc';
    renderRanking(_breaks); savePrefs();
  });

  // ranking: tamanho (Top 5 / 10 / 27)
  document.getElementById('rankSize').addEventListener('change', (e)=>{
    _rankTop = parseInt(e.target.value, 10);
    renderRanking(_breaks); savePrefs();
  });

  // ranking: mostrar valores na barra
  document.getElementById('rankValuesInBar').addEventListener('change', (e)=>{
    _rankShowValuesInBar = e.target.checked;
    renderRanking(_breaks); savePrefs();
  });

  // ranking: linhas alternadas
  document.getElementById('rankAltRows').addEventListener('change', (e)=>{
    _rankAltRows = e.target.checked;
    renderRanking(_breaks); savePrefs();
  });

  // ranking: CSV
  document.getElementById('btnRankCSV').addEventListener('click', exportRankingCSV);

  // tabela: ocultar coluna valor
  document.getElementById('toggleHideMetricCol').addEventListener('change', (e)=>{
    _hideMetricCol = e.target.checked;
    renderTable(); savePrefs();
  });

  // copiar PNG
  document.getElementById('btnCopyPng').addEventListener('click', copyMapAsPNG);

  // APLICA PREFER√äNCIAS ANTES DE DESENHAR
  applyPrefsToUI(loadPrefs());

  // Mapa
  map = L.map('map').setView([-14.235, -51.9253], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap', crossOrigin: true
  }).addTo(map);
  const gj = await fetch(GEOJSON_URL).then(r=>r.json());

  layer = L.geoJSON(gj, {
    style: feature => ({ color:'#0ad7ff', weight:1, fillColor:'#0e1a2c', fillOpacity:0.65 }),
    onEachFeature: (feature, l) => {
      const uf = name2uf[feature.properties.name] || '';
      _layersByUF[uf] = l;
      l.on('click', ()=> showPopup(uf, l));
      l.on('mouseover', ()=> l.setStyle({ weight:2 }));
      l.on('mouseout', ()=> l.setStyle({ weight:1 }));
    }
  }).addTo(map);

  draw();
}
init();
</script>
</body>
</html>
